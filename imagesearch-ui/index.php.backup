<?php session_start(); 

//var_dump($_POST);
//var_dump($_SESSION);
//echo "\n\n *********************************\n";
if(isset($_SESSION['files'])){
	//print_r($_SESSION['files']);
	//echo "\n\n TYPE: ";
	//print_r($_SESSION['type']);		
}

?>
<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>CC Images </title>
	<!-- StyleSheets-->
	<link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
	<?php include("navigate.php");
	activate($filen);
	echo "\n ************************************************\n";
	var_dump($_SESSION['results']);
	?>
	<div class="container">
		<h1>Image Search and Licensing Tool</h1>
		<div class="row">
			<form action="upload5.php" method="post" enctype="multipart/form-data">
				<div class="form-group">
					<label for="exampleInputEmail1">Image url</label>
					<input type="text" name="url" class="form-control" id="url" placeholder="Enter email">
				</div>
				<div class="form-group">
					<label for="fileToUpload">File input</label>
					<input type="file"  name="fileToUpload" id="fileToUpload">
					<p class="help-block">Browse your PC to Select Image</p>
				</div>
				<div class="checkbox">
					<label>
						<input type="checkbox"> Add Image to Registry
					</label>
				</div>
				<button type="submit" class="btn btn-primary" value="Upload Image" name="submit" >Submit</button>
			</form>
		</div>

<?php
if(isset($_SESSION['results'])){
	//echo "SESSION IS SET RESULTS ++++++++";
	$idstring=$_SESSION['results'];
	//echo "\n\n ID".$idstring;

 	echo  '<div class="row"><div class="col-sm-3">
 		   <h2>Original Image</h2>';
 	//echo $_SESSION['original'];
 	echo '<img style="border: 2px solid black;" width="200" src="uploads/'.$_SESSION['original'].'" ?></br></div>';	

$servername = "localhost";
$username = "anna";
$password = "password";
$dbname = "hashes";

// Create connection
$conn = new mysqli($servername, $username, $password, $dbname);
// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
} 


//$sql = "SELECT * FROM IMG where id IN (2, 5, 11, 20);";
$sql = "SELECT * FROM IMG where id IN(".$idstring.");";
$result = $conn->query($sql);

if ($result->num_rows > 0) {
	//print_r($result);
	//echo "\n\n COUNT: ".$result->num_rows;
    // output data of each row
    echo '<div class="col-sm-9" style = "border: 2px solid black;"><h2>Matches</h2>';
    while($row = $result->fetch_assoc()) {
        //echo "id: " . $row["id"]. $row["phash"]. $row["name"].$row["author"]. $row["bhash"].
          //"\n\n COUNTER".$counter++;

        $pattern = "/CC-BY-SA\w*/i";
        $pattern2 = "/CC-BY\w*/i";
        $pattern_pd = "/PD\w*/i";

        preg_match($pattern, $row['license'], $matches, PREG_OFFSET_CAPTURE);
        preg_match($pattern2, $row['license'], $matches_by, PREG_OFFSET_CAPTURE);
        preg_match($pattern_pd, $row['license'], $matches_pd, PREG_OFFSET_CAPTURE);
     
        echo '<div class="row"><img width="200" src="data:image/jpeg;base64,' . base64_encode( $row['image'] ) . '" /></div>';
        echo "\n\n";
        if(!empty($matches))
        {
            
            echo '<div class="row">LICENSE: '.$row['license'].'</div>';
            echo '</br></br><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                 <img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />
                 This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>';
            echo '<div class="row"><p>AUTHOR: '.$row['authorname'].'</p><p>URL: <a href="'.$row[url].'"target="_blank">LINK TO IMAGE</a></p></div>';
        
        }else if (!empty($matches_by)){

            echo '<div class="row">LICENSE: '.$row['license'].'</div>';
            echo '</br></br><a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                  <img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />
                  This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                  Creative Commons Attribution 4.0 International License</a>';
            echo '<div class="row"><p>AUTHOR: '.$row['authorname'].'</p><p>URL: <a href="'.$row[url].'"target="_blank">LINK TO IMAGE</a></p></div>';
      
        } else if (!empty($matches_pd)){
            echo '<div class="row">LICENSE: '.$row['license'].'</div>';
            echo '</br></br><a rel="license" href="http://creativecommons.org/licenses/pdm/4.0/">
                    <img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/p/mark/1.0/88x31.png" /></a><br />
                    This work is licensed under a <a rel="license" href="https://creativecommons.org/publicdomain/">
                    Creative Commons Public Domain Mark</a>';
            echo '<div class="row"><p>AUTHOR: '.$row['authorname'].'</p><p>URL: <a href="'.$row[url].'"target="_blank">LINK TO IMAGE</a></p></div>';
     

        }


    }
    echo '</div>';
} else {
    echo "0 results";
}
} ?>
</div>
	<script src="jquery-1.11.3.min.js"></script>
	<script src="js/bootstrap.min.js"></script>	
</body>
</html>
